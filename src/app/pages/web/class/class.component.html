<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header bg-light" *ngIf="currentClass">
                    <div class="row">
                        <!-- Cột thông tin lớp học -->
                        <div class="col-md-6 border-end pe-4">
                            <h5 class="text-primary mb-3"><i class="bi bi-book me-2"></i> Thông tin lớp học</h5>
                            <ul class="list-unstyled text-dark mb-0">
                                <li class="mb-2 d-flex align-items-center">
                                    <i class="bi bi-people-fill me-2 fs-5 text-info"></i>
                                    <div>
                                        <span class="fw-bold text-dark">Lớp:</span>
                                        <span class="text-muted">{{ currentClass.name }}</span>
                                    </div>
                                </li>
                                <li class="mb-2 d-flex align-items-center">
                                    <i class="bi bi-geo-alt-fill me-2 fs-5 text-info"></i>
                                    <div>
                                        <span class="fw-bold text-dark">Phòng học:</span>
                                        <span class="text-muted">{{ currentClass.room }}</span>
                                    </div>
                                </li>
                                <li class="mb-2 d-flex align-items-center">
                                    <i class="bi bi-clock-fill me-2 fs-5 text-info"></i>
                                    <div>
                                        <span class="fw-bold text-dark">Ca học:</span>
                                        <span class="text-muted">{{ currentClass.schedule }}</span>
                                    </div>
                                </li>
                            </ul>
                        </div>

                        <!-- Cột thông tin giảng viên -->
                        <div class="col-md-6 ps-4">
                            <h5 class="text-primary mb-3">
                                <i class="bi bi-person-vcard me-2"></i> Thông tin giảng viên
                            </h5>
                            <ul class="list-unstyled text-dark mb-0">
                                <li class="mb-2 d-flex align-items-center">
                                    <i class="bi bi-person-fill me-2 fs-5 text-success"></i>
                                    <div>
                                        <span class="fw-bold text-dark">Tên giảng viên:</span>
                                        <span class="text-muted">{{ currentClass.lecturerName }}</span>
                                    </div>
                                </li>
                                <li class="mb-2 d-flex align-items-center">
                                    <i class="bi bi-envelope-fill me-2 fs-5 text-success"></i>
                                    <div>
                                        <span class="fw-bold text-dark">Email:</span>
                                        <span class="text-muted">{{ currentClass.lecturerEmail }}</span>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <div class="accordion" id="lessionsAccordion">
                        <!-- Hiệu ứng loading ở đây -->
                        <div *ngIf="isLoadingLessions" class="text-center mb-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>

                        <div *ngFor="let lession of lessions" class="accordion-item mb-3">
                            <h2 class="accordion-header">
                                <button
                                    class="accordion-button"
                                    [class.collapsed]="!isLessionExpanded(lession.id)"
                                    type="button"
                                    (click)="toggleLession(lession.id)"
                                >
                                    {{ lession.name }}
                                </button>
                            </h2>
                            <div class="accordion-collapse collapse" [class.show]="isLessionExpanded(lession.id)">
                                <div class="accordion-body">
                                    <!-- Hiệu ứng loading ở đây -->
                                    <div *ngIf="loadingResources.has(lession.id)" class="text-center mb-3">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>

                                    <!-- Tài liệu -->
                                    <div class="mb-4">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5>Tài liệu</h5>
                                        </div>

                                        <div
                                            *ngIf="lession.documents?.length === 0 && !loadingResources.has(lession.id)"
                                            class="text-muted"
                                        >
                                            Chưa có tài liệu nào
                                        </div>

                                        <div *ngFor="let document of lession.documents" class="card mb-2">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div class="flex-grow-1">
                                                        <h6
                                                            class="card-title"
                                                            style="cursor: pointer"
                                                            (click)="viewDocumentDetail(document, documentDetailModal)"
                                                        >
                                                            {{ document.title }}
                                                        </h6>
                                                        <p class="card-text">
                                                            <strong>File đính kèm: </strong>
                                                            <span
                                                                (click)="downloadFile(document.fileId)"
                                                                style="cursor: pointer"
                                                                class="text-decoration-underline text-info"
                                                                >{{ document.fileName }}</span
                                                            >
                                                        </p>
                                                        <small class="text-muted">
                                                            <i class="bi bi-clock me-1 text-primary"></i>
                                                            Tạo ngày: {{ document.uploadAt | date: 'dd/MM/yyyy' }}
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Bài tập -->
                                    <div class="mb-4">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5>Bài tập</h5>
                                        </div>

                                        <div
                                            *ngIf="
                                                lession.assignments?.length === 0 && !loadingResources.has(lession.id)
                                            "
                                            class="text-muted"
                                        >
                                            Chưa có bài tập nào
                                        </div>

                                        <div *ngFor="let assignment of lession.assignments" class="card mb-2">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div class="flex-grow-1">
                                                        <h6 class="card-title">
                                                            <a
                                                                href="javascript:void(0)"
                                                                class="text-decoration-none"
                                                                (click)="goToSubmissions(assignment.id)"
                                                            >
                                                                {{ assignment.title }}
                                                            </a>
                                                        </h6>
                                                        <small class="text-muted">
                                                            <i class="bi bi-calendar me-1 text-primary"></i>
                                                            Hạn nộp: {{ assignment.deadline | date: 'dd/MM/yyyy' }}
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Thông báo lớp học -->
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">Thông báo lớp học</h4>
                        <button class="btn btn-outline-secondary" (click)="toggleAnnouncementDropdown()">
                            <i
                                class="bi"
                                [class.bi-chevron-down]="!showAnnouncementDropdown"
                                [class.bi-chevron-up]="showAnnouncementDropdown"
                            ></i>
                        </button>
                    </div>
                </div>
                <div class="card-body" [class.d-none]="!showAnnouncementDropdown">
                    <div *ngIf="announcements.contents" class="text-muted">Chưa có thông báo nào</div>

                    <!-- Hiệu ưng loading ở đây -->
                    <div *ngIf="isLoadingAnnouncements" class="text-center mb-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>

                    <div *ngFor="let announcement of announcements.contents" class="card mb-4" style="cursor: pointer">
                        <div class="card-body">
                            <h6 class="card-title">{{ announcement.title }}</h6>
                            <div class="card-text">
                                <div
                                    class="text-decoration-none"
                                    (click)="viewAnnouncementDetail(announcement, announcementDetailModal)"
                                >
                                    {{
                                        announcement.content.length > 100
                                            ? (announcement.content | slice: 0 : 100) + '...'
                                            : announcement.content
                                    }}
                                </div>
                            </div>
                            <small class="text-muted">
                                <i class="bi bi-calendar me-1"></i>
                                {{ announcement.createdAt | date: 'dd/MM/yyyy HH:mm' }}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal chi tiết thông báo - Improved -->
<ng-template #announcementDetailModal let-modal>
    <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-info px-4">
            <h5 class="modal-title fw-semibold text-white">
                <i class="bi bi-file-earmark-text me-2"></i>{{ selectedAnnouncement?.title }}
            </h5>
            <button type="button" class="btn-close btn-close-white" (click)="modal.dismiss('cancel')"></button>
        </div>
        <div class="modal-body p-4">
            <div class="mb-4">
                <div class="border p-3 bg-light rounded">
                    <div class="preformatted-text" [innerHTML]="selectedAnnouncement?.content"></div>
                </div>
            </div>
            <div class="text-muted small">
                <i class="bi bi-calendar me-1"></i>
                Ngày tạo: {{ selectedAnnouncement?.createdAt | date: 'dd/MM/yyyy HH:mm' }}
            </div>
        </div>
        <div class="modal-footer bg-light">
            <button type="button" class="btn btn-outline-secondary rounded-2 px-4" (click)="modal.dismiss('cancel')">
                Đóng
            </button>
        </div>
    </div>
</ng-template>

<!-- Modal chi tiết tài liệu - Improved -->
<ng-template #documentDetailModal let-modal>
    <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-info px-4">
            <h5 class="modal-title fw-semibold text-white">
                <i class="bi bi-file-earmark-text me-2"></i>{{ selectedDocument?.title }}
            </h5>
            <button type="button" class="btn-close btn-close-white" (click)="modal.dismiss('cancel')"></button>
        </div>
        <div class="modal-body p-4">
            <div class="mb-4">
                <div class="border p-3 bg-light rounded">
                    <div class="preformatted-text" [innerHTML]="selectedDocument?.content"></div>
                </div>
            </div>
            <p class="card-text">
                <i class="bi bi-file-earmark me-1 text-info"></i>
                <strong>File đính kèm: </strong>
                <span
                    (click)="downloadFile(selectedDocument?.fileId)"
                    class="text-decoration-underline text-info-emphasis"
                    style="cursor: pointer"
                    >{{ selectedDocument?.fileName }}</span
                >
            </p>
            <p class="card-text">
                <i class="bi bi-calendar me-1 text-info"></i>
                <strong>Ngày tạo: </strong>
                {{ selectedDocument?.uploadAt | date: 'dd/MM/yyyy' }}
            </p>
        </div>
        <div class="modal-footer bg-light">
            <button type="button" class="btn btn-outline-secondary rounded-2 px-4" (click)="modal.dismiss('cancel')">
                Đóng
            </button>
        </div>
    </div>
</ng-template>
