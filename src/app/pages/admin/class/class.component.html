<div class="container-fluid p-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">Quản lý lớp học</h2>
            <p class="text-muted mb-0" *ngIf="currentCourse">Khóa học: {{ currentCourse.name }}</p>
        </div>
        <div class="col-md-4">
            <!-- Semester Selector -->
            <select
                class="form-select"
                [(ngModel)]="selectedSemesterId"
                [disabled]="isLoading"
                (change)="onSemesterChange()"
            >
                <option value="" disabled>Chọn học kỳ</option>
                <option *ngFor="let semester of semesters" [value]="semester.id">
                    {{ semester.name }}
                </option>
            </select>
        </div>
        <button type="button" class="btn btn-primary" (click)="openCreateClassModal(createClassModal)">
            <i class="bi bi-plus-circle me-2"></i>Thêm lớp mới
        </button>
    </div>

    <!-- Classes Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <!-- Loading Overlay -->
                <div
                    *ngIf="isLoading"
                    class="position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-white bg-opacity-75"
                    style="z-index: 10"
                >
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Tên lớp</th>
                            <th scope="col">Phòng dạy</th>
                            <th scope="col">Tên giảng viên</th>
                            <th scope="col">Email giảng viên</th>
                            <th scope="col">Ca dạy</th>
                            <th scope="col" class="text-center">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let class of classes; let i = index">
                            <td>{{ i + 1 }}</td>
                            <td>
                                <strong>{{ class.name }}</strong>
                            </td>
                            <td>
                                <span>{{ class.room }}</span>
                            </td>
                            <td>
                                <span>{{ class.lecturerName }}</span>
                            </td>
                            <td>
                                <span>{{ class.lecturerEmail }}</span>
                            </td>

                            <td>
                                <span class="badge bg-info">{{ class.schedule }}</span>
                            </td>
                            <td class="text-center">
                                <div class="btn-group" role="group">
                                    <button
                                        type="button"
                                        class="btn btn-sm btn-outline-primary"
                                        (click)="viewStudents(class.id)"
                                        title="Xem danh sách học viên"
                                    >
                                        <i class="bi bi-people"></i>
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-sm btn-outline-danger"
                                        (click)="setClassToDelete(class, deleteModal)"
                                        title="Xóa lớp"
                                    >
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr *ngIf="classes.length === 0">
                            <td colspan="7" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="bi bi-inbox display-4 d-block mb-3"></i>
                                    <p>Chưa có lớp học nào</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Create Class Modal - Improved -->
<ng-template #createClassModal let-modal>
    <div class="modal-content border-0 shadow-lg">
        <!-- Modal Header -->
        <div class="modal-header bg-primary text-white">
            <h5 class="modal-title fw-semibold" id="createClassModalLabel">
                <i class="bi bi-people-fill me-2"></i>Tạo lớp mới
            </h5>
            <button
                type="button"
                class="btn-close btn-close-white"
                (click)="modal.dismiss('cancel')"
                aria-label="Close"
            ></button>
        </div>

        <div class="modal-body p-4">
            <form #createForm="ngForm">
                <!-- Semester Selection -->
                <div class="mb-4">
                    <label for="semester" class="form-label fw-medium">
                        <i class="bi bi-calendar3 me-1 text-primary"></i>Học kì <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-primary">
                            <i class="bi bi-list-check text-primary"></i>
                        </span>
                        <select
                            class="form-select form-select-lg border-primary border-end-1"
                            id="semester"
                            [(ngModel)]="newClass.semesterId"
                            name="semester"
                            required
                        >
                            <option value="" disabled selected>Chọn học kỳ</option>
                            <option *ngFor="let semester of semesters" [value]="semester.id">
                                {{ semester.name }}
                            </option>
                        </select>
                    </div>
                </div>

                <!-- Class Name -->
                <div class="mb-4">
                    <label for="className" class="form-label fw-medium">
                        <i class="bi bi-tag me-1 text-primary"></i>Tên lớp <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-primary">
                            <i class="bi bi-pencil text-primary"></i>
                        </span>
                        <input
                            type="text"
                            class="form-control form-control-lg border-primary border-end-1"
                            id="className"
                            [(ngModel)]="newClass.name"
                            name="className"
                            required
                            placeholder="Nhập tên lớp học"
                        />
                    </div>
                </div>

                <!-- Classroom -->
                <div class="mb-4">
                    <label for="classRoom" class="form-label fw-medium">
                        <i class="bi bi-building me-1 text-primary"></i>Phòng học <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-primary">
                            <i class="bi bi-door-open text-primary"></i>
                        </span>
                        <input
                            type="text"
                            class="form-control form-control-lg border-primary border-end-1"
                            id="classRoom"
                            [(ngModel)]="newClass.room"
                            name="classRoom"
                            required
                            placeholder="Phòng học (ví dụ: A101, B202, ...)"
                        />
                    </div>
                </div>

                <!-- Class Schedule -->
                <div class="mb-4">
                    <label for="classSchedule" class="form-label fw-medium">
                        <i class="bi bi-clock me-1 text-primary"></i>Ca dạy <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-primary">
                            <i class="bi bi-alarm text-primary"></i>
                        </span>
                        <select
                            class="form-select form-select-lg border-primary border-end-1"
                            id="classSchedule"
                            [(ngModel)]="newClass.shift"
                            name="classSchedule"
                            required
                        >
                            <option value="" disabled selected>Chọn ca dạy</option>
                            <option *ngFor="let shift of shifts" [value]="shift.value">
                                {{ shift.title }}
                            </option>
                        </select>
                    </div>
                </div>

                <!-- Week Days Selection -->
                <div class="mb-4">
                    <label class="form-label fw-medium">
                        <i class="bi bi-calendar-week me-1 text-primary"></i>Ngày học trong tuần
                    </label>
                    <div class="row g-2">
                        <div class="col-4" *ngFor="let day of weekDays">
                            <div
                                class="form-check card p-2 flex-row"
                                [ngClass]="{ 'border border-primary': newClass.daysInWeek.includes(day.value) }"
                                (click)="onDaySelectionChange(day.value)"
                                style="cursor: pointer"
                            >
                                <label class="form-check-label d-flex align-items-center" [for]="'day' + day.value">
                                    <i class="bi bi-calendar-day me-2 text-muted"></i>
                                    {{ day.label }}
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Instructor Selection -->
                <div class="mb-4">
                    <label class="form-label fw-medium">
                        <i class="bi bi-person-video3 me-1 text-primary"></i>Giảng viên
                        <span class="text-danger">*</span>
                    </label>

                    <!-- Search Input -->
                    <div class="position-relative mb-2">
                        <div class="input-group">
                            <span class="input-group-text bg-light border-primary">
                                <i class="bi bi-search text-primary"></i>
                            </span>
                            <input
                                type="text"
                                class="form-control form-control-lg border-primary border-end-1"
                                [(ngModel)]="instructorSearchTerm"
                                (input)="onInstructorSearch()"
                                name="instructorSearch"
                                placeholder="Tìm kiếm giảng viên..."
                                autocomplete="off"
                            />
                        </div>

                        <!-- Search Results Dropdown -->
                        <div
                            *ngIf="instructors.length > 0"
                            class="dropdown-menu show position-absolute w-100 mt-1 shadow"
                            style="max-height: 250px; overflow-y: auto; z-index: 1050"
                        >
                            <button
                                *ngFor="let instructor of instructors"
                                type="button"
                                class="dropdown-item d-flex align-items-center py-2"
                                (click)="selectInstructor(instructor)"
                            >
                                <div class="me-3">
                                    <i class="bi bi-person-circle fs-5 text-primary"></i>
                                </div>
                                <div>
                                    <strong>{{ instructor.fullname }}</strong>
                                    <div class="text-muted small">{{ instructor.email }}</div>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- Selected Instructor Display -->
                    <div class="border rounded p-3" [class.bg-light]="selectedInstructor">
                        <div *ngIf="selectedInstructor; else noInstructorSelected">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-person-check fs-4 text-success me-3"></i>
                                    <div>
                                        <h6 class="mb-0">{{ selectedInstructor.fullname }}</h6>
                                        <small class="text-muted">{{ selectedInstructor.email }}</small>
                                    </div>
                                </div>
                                <button
                                    type="button"
                                    class="btn btn-sm btn-outline-danger rounded-circle"
                                    (click)="clearSelectedInstructor()"
                                    title="Bỏ chọn"
                                >
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                        <ng-template #noInstructorSelected>
                            <div class="text-center text-muted py-2">
                                <i class="bi bi-person-x me-2"></i>
                                Chưa chọn giảng viên
                            </div>
                        </ng-template>
                    </div>
                </div>

                <!-- Student File Upload -->
                <div class="mb-4">
                    <label for="studentFile" class="form-label fw-medium">
                        <i class="bi bi-file-earmark-excel me-1 text-primary"></i>Danh sách học viên
                        <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-primary">
                            <i class="bi bi-upload text-primary"></i>
                        </span>
                        <input
                            type="file"
                            class="form-control form-control-lg border-primary border-end-1"
                            id="studentFile"
                            (change)="onFileSelected($event)"
                            accept=".xlsx,.xls"
                        />
                    </div>
                    <div class="form-text text-muted">
                        <i class="bi bi-info-circle me-1"></i>Vui lòng tải lên file Excel chứa danh sách học viên
                        (student code)
                    </div>
                </div>

                <!-- Selected File Info -->
                <div class="alert alert-success d-flex align-items-center" *ngIf="selectedFile">
                    <i class="bi bi-check-circle-fill me-3 fs-4"></i>
                    <div>
                        <strong>File đã chọn:</strong> {{ selectedFile.name }}
                        <div class="small">Kích thước: {{ formatFileSize(selectedFile.size) }}</div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Modal Footer -->
        <div class="modal-footer bg-light">
            <button type="button" class="btn btn-outline-secondary rounded-2 px-4" (click)="modal.dismiss('cancel')">
                Hủy
            </button>
            <button
                type="button"
                class="btn btn-primary rounded-2 px-4"
                [disabled]="disableCreateButton()"
                (click)="createClass()"
            >
                <span *ngIf="isCreating" class="spinner-border spinner-border-sm me-2"></span>
                <i *ngIf="!isCreating" class="bi bi-save me-2"></i>
                Tạo lớp
            </button>
        </div>
    </div>
</ng-template>

<!-- Delete Confirmation Modal -->
<ng-template #deleteModal let-modal>
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel">Xác nhận xóa</h5>
            <button type="button" class="btn-close" (click)="modal.dismiss('cancel')"></button>
        </div>
        <div class="modal-body">
            <div class="text-center">
                <i class="bi bi-exclamation-triangle text-warning display-4 mb-3"></i>
                <p class="mb-3">Bạn có chắc chắn muốn xóa lớp</p>
                <p class="fw-bold text-danger">{{ classToDelete?.name }}?</p>
                <p class="text-muted small">
                    Hành động này không thể hoàn tác. Các dữ liệu liên quan của lớp sẽ bị xóa theo, hãy đảm bảo tất cả
                    dữ liệu đã được sao lưu.
                </p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="modal.dismiss('cancel')">Hủy</button>
            <button type="button" class="btn btn-danger" (click)="deleteClass()" [disabled]="isDeleting">
                <i *ngIf="!isDeleting" class="bi bi-trash me-2"></i>
                <i *ngIf="isDeleting" class="bi bi-arrow-clockwise spinner-border spinner-border-sm me-2"></i>
                Xóa
            </button>
        </div>
    </div>
</ng-template>
