<div class="container-fluid p-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">Quản lý lớp học</h2>
            <p class="text-muted mb-0" *ngIf="currentCourse">Khóa học: {{ currentCourse.name }}</p>
        </div>
        <div class="col-md-4">
            <!-- Semester Selector -->
            <select class="form-select" [(ngModel)]="selectedSemesterId" (change)="onSemesterChange()">
                <option value="" disabled>Chọn học kỳ</option>
                <option *ngFor="let semester of semesters" [value]="semester.id">
                    {{ semester.name }}
                </option>
            </select>
        </div>
        <button type="button" class="btn btn-primary" (click)="openCreateClassModal(createClassModal)">
            <i class="bi bi-plus-circle me-2"></i>Thêm lớp mới
        </button>
    </div>

    <!-- Classes Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <!-- Loading Overlay -->
                <div
                    *ngIf="isLoading"
                    class="position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-white bg-opacity-75"
                    style="z-index: 10"
                >
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Tên lớp</th>
                            <th scope="col">Phòng dạy</th>
                            <th scope="col">Tên giảng viên</th>
                            <th scope="col">Email giảng viên</th>
                            <th scope="col">Ca dạy</th>
                            <th scope="col" class="text-center">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let class of classes; let i = index">
                            <td>{{ i + 1 }}</td>
                            <td>
                                <strong>{{ class.name }}</strong>
                            </td>
                            <td>
                                <span>{{ class.room }}</span>
                            </td>
                            <td>
                                <span>{{ class.lecturerName }}</span>
                            </td>
                            <td>
                                <span>{{ class.lecturerEmail }}</span>
                            </td>

                            <td>
                                <span class="badge bg-info">{{ class.schedule }}</span>
                            </td>
                            <td class="text-center">
                                <div class="btn-group" role="group">
                                    <button
                                        type="button"
                                        class="btn btn-sm btn-outline-primary"
                                        (click)="viewStudents(class.id)"
                                        title="Xem danh sách học viên"
                                    >
                                        <i class="bi bi-people"></i>
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-sm btn-outline-danger"
                                        (click)="setClassToDelete(class, deleteModal)"
                                        title="Xóa lớp"
                                    >
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr *ngIf="classes.length === 0">
                            <td colspan="5" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="bi bi-inbox display-4 d-block mb-3"></i>
                                    <p>Chưa có lớp học nào</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Create Class Modal -->
<ng-template #createClassModal let-modal>
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="createClassModalLabel">Tạo lớp mới</h5>
            <button type="button" class="btn-close" (click)="modal.dismiss('cancel')" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <form #createForm="ngForm">
                <div class="mb-3">
                    <label for="semester" class="form-label">Học kì <span class="text-danger">*</span></label>
                    <select
                        class="form-select"
                        id="semester"
                        [(ngModel)]="newClass.semesterId"
                        name="semester"
                        required
                    >
                        <option value="" disabled>Chọn học kỳ</option>
                        <option *ngFor="let semester of semesters" [value]="semester.id">
                            {{ semester.name }}
                        </option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="className" class="form-label">Tên lớp <span class="text-danger">*</span></label>
                    <input
                        type="text"
                        class="form-control"
                        id="className"
                        [(ngModel)]="newClass.name"
                        name="className"
                        required
                        placeholder="Nhập tên lớp học"
                    />
                </div>

                <div class="mb-3">
                    <label for="classRoom" class="form-label">Phòng học <span class="text-danger">*</span></label>
                    <input
                        type="text"
                        class="form-control"
                        id="classRoom"
                        [(ngModel)]="newClass.room"
                        name="classRoom"
                        required
                        placeholder="Phòng học (ví dụ: A101, B202, ...)"
                    />
                </div>

                <div class="mb-3">
                    <label for="classSchedule" class="form-label">Ca dạy <span class="text-danger">*</span></label>
                    <select
                        class="form-select"
                        id="classSchedule"
                        [(ngModel)]="newClass.shift"
                        name="classSchedule"
                        required
                    >
                        <option value="">Chọn ca dạy</option>
                        <option *ngFor="let shift of shifts" [value]="shift.value">
                            {{ shift.title }}
                        </option>
                    </select>
                </div>

                <!-- Chọn các thứ trong tuần -->
                <div class="mb-3">
                    <label class="form-label">Chọn các ngày trong tuần</label>
                    <div class="row">
                        <div class="col-4 mb-2" *ngFor="let day of weekDays">
                            <div class="form-check">
                                <input
                                    class="form-check-input"
                                    type="checkbox"
                                    [value]="day.value"
                                    [checked]="newClass.daysInWeek.includes(day.value)"
                                    (change)="onDaySelectionChange($event)"
                                    id="day{{ day.value }}"
                                />
                                <label class="form-check-label" [for]="'day' + day.value">
                                    {{ day.label }}
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Giảng viên -->
                <div class="mb-3">
                    <label class="form-label"> Giảng viên đứng lớp <span class="text-danger">*</span> </label>

                    <!-- Search Input -->
                    <div class="position-relative">
                        <input
                            type="text"
                            class="form-control"
                            [(ngModel)]="instructorSearchTerm"
                            (input)="onInstructorSearch()"
                            name="instructorSearch"
                            placeholder="Tìm kiếm giảng viên theo tên hoặc email..."
                            autocomplete="off"
                        />

                        <!-- Search Results Dropdown -->
                        <div
                            *ngIf="instructors.length > 0"
                            class="dropdown-menu show position-absolute w-100 mt-1"
                            style="max-height: 200px; overflow-y: auto; z-index: 1050"
                        >
                            <button
                                *ngFor="let instructor of instructors"
                                type="button"
                                class="dropdown-item"
                                (click)="selectInstructor(instructor)"
                            >
                                <div>
                                    <strong>{{ instructor.fullname }}</strong>
                                    <br />
                                    <small class="text-muted">{{ instructor.email }}</small>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- Selected Instructor Display -->
                    <div class="mt-2 p-3 border rounded" [class.bg-light]="selectedInstructor">
                        <div *ngIf="selectedInstructor; else noInstructorSelected">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">{{ selectedInstructor.fullname }}</h6>
                                    <small class="text-muted">{{ selectedInstructor.email }}</small>
                                </div>
                                <button
                                    type="button"
                                    class="btn btn-outline-secondary btn-sm"
                                    (click)="clearSelectedInstructor()"
                                    title="Bỏ chọn"
                                >
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                        <ng-template #noInstructorSelected>
                            <div class="text-muted text-center">
                                <i class="bi bi-person-plus me-2"></i>
                                Vui lòng chọn giảng viên
                            </div>
                        </ng-template>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="studentFile" class="form-label"
                        >Import danh sách học viên (Excel) <span class="text-danger">*</span></label
                    >
                    <input
                        type="file"
                        class="form-control"
                        id="studentFile"
                        (change)="onFileSelected($event)"
                        accept=".xlsx,.xls"
                    />
                </div>

                <div class="alert alert-info" *ngIf="selectedFile">
                    <i class="bi bi-file-earmark-excel me-2"></i>
                    <strong>File đã chọn:</strong> {{ selectedFile.name }}
                    <small class="d-block mt-1">Kích thước: {{ formatFileSize(selectedFile.size) }}</small>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="modal.dismiss('cancel')">Hủy</button>
            <button type="button" class="btn btn-primary" [disabled]="disableCreateButton()" (click)="createClass()">
                <i *ngIf="!isCreating" class="bi bi-plus-circle me-2"></i>
                <i *ngIf="isCreating" class="bi bi-arrow-clockwise spinner-border spinner-border-sm me-2"></i>
                Tạo lớp
            </button>
        </div>
    </div>
</ng-template>

<!-- Delete Confirmation Modal -->
<ng-template #deleteModal let-modal>
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel">Xác nhận xóa</h5>
            <button type="button" class="btn-close" (click)="modal.dismiss('cancel')"></button>
        </div>
        <div class="modal-body">
            <div class="text-center">
                <i class="bi bi-exclamation-triangle text-warning display-4 mb-3"></i>
                <p class="mb-3">Bạn có chắc chắn muốn xóa lớp</p>
                <p class="fw-bold text-danger">{{ classToDelete?.name }}?</p>
                <p class="text-muted small">
                    Hành động này không thể hoàn tác. Các dữ liệu liên quan của lớp sẽ bị xóa theo, hãy đảm bảo tất cả
                    dữ liệu đã được sao lưu.
                </p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="modal.dismiss('cancel')">Hủy</button>
            <button type="button" class="btn btn-danger" (click)="deleteClass()" [disabled]="isDeleting">
                <i *ngIf="!isDeleting" class="bi bi-trash me-2"></i>
                <i *ngIf="isDeleting" class="bi bi-arrow-clockwise spinner-border spinner-border-sm me-2"></i>
                Xóa
            </button>
        </div>
    </div>
</ng-template>
