<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="class-manage-header d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-4">Quản lý lớp học</h2>
                <button class="btn btn-primary" (click)="goToManageStudent()">
                    <i class="bi bi-people-fill me-2"></i>
                    Danh sách sinh viên
                </button>
            </div>

            <!-- Quản lý buổi học -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="mb-0">Quản lý buổi học</h4>
                </div>
                <div class="card-body">
                    <div class="accordion" id="lessionsAccordion">
                        <div *ngFor="let lession of lessions" class="accordion-item mb-3">
                            <h2 class="accordion-header">
                                <button
                                    class="accordion-button"
                                    [class.collapsed]="!isLessionExpanded(lession.id)"
                                    type="button"
                                    (click)="toggleLession(lession.id)"
                                >
                                    {{ lession.name }}
                                </button>
                            </h2>
                            <div class="accordion-collapse collapse" [class.show]="isLessionExpanded(lession.id)">
                                <div class="accordion-body">
                                    <!-- Tài liệu -->
                                    <div class="mb-4">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5>Tài liệu</h5>
                                            <button
                                                class="btn btn-primary btn-sm"
                                                (click)="openDocumentModal(lession.id, createDocumentModal)"
                                            >
                                                <i class="bi bi-plus"></i> Thêm tài liệu
                                            </button>
                                        </div>

                                        <div *ngIf="lession.documents?.length === 0" class="text-muted">
                                            Chưa có tài liệu nào
                                        </div>

                                        <div *ngFor="let document of lession.documents" class="card mb-2">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div class="flex-grow-1">
                                                        <h6 class="card-title">{{ document.title }}</h6>
                                                        <p class="card-text">{{ document.content }}</p>
                                                        <p class="card-text">
                                                            <strong>File đính kèm: </strong>
                                                            <a href="#" class="text-decoration-none">{{
                                                                document.fileName
                                                            }}</a>
                                                        </p>
                                                        <small class="text-muted">
                                                            <i class="bi bi-clock me-1 text-primary"></i>
                                                            Tạo ngày: {{ document.uploadAt | date: 'dd/MM/yyyy' }}
                                                        </small>
                                                    </div>
                                                    <button
                                                        class="btn btn-outline-danger btn-sm"
                                                        (click)="confirmDeleteDocument(document, deleteDocumentModal)"
                                                    >
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Bài tập -->
                                    <div class="mb-4">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5>Bài tập</h5>
                                            <button
                                                class="btn btn-success btn-sm"
                                                (click)="openAssignmentModal(lession.id, createAssignmentModal)"
                                            >
                                                <i class="bi bi-plus"></i> Thêm bài tập
                                            </button>
                                        </div>

                                        <div *ngIf="lession.assignments?.length === 0" class="text-muted">
                                            Chưa có bài tập nào
                                        </div>

                                        <div *ngFor="let assignment of lession.assignments" class="card mb-2">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div class="flex-grow-1">
                                                        <h6 class="card-title">
                                                            <a
                                                                href="javascript:void(0)"
                                                                class="text-decoration-none"
                                                                (click)="goToSubmissions(lession.id)"
                                                            >
                                                                {{ assignment.title }}
                                                            </a>
                                                        </h6>
                                                        <small class="text-muted">
                                                            <i class="bi bi-calendar me-1 text-primary"></i>
                                                            Hạn nộp: {{ assignment.deadline | date: 'dd/MM/yyyy' }}
                                                        </small>
                                                    </div>
                                                    <button
                                                        class="btn btn-outline-danger btn-sm"
                                                        (click)="
                                                            confirmDeleteAssignment(assignment, deleteAssignmentModal)
                                                        "
                                                    >
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Thông báo lớp học -->
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">Thông báo lớp học</h4>
                        <button class="btn btn-outline-secondary" (click)="toggleAnnouncementDropdown()">
                            <i
                                class="bi"
                                [class.bi-chevron-down]="!showAnnouncementDropdown"
                                [class.bi-chevron-up]="showAnnouncementDropdown"
                            ></i>
                        </button>
                    </div>
                </div>
                <div class="card-body" [class.d-none]="!showAnnouncementDropdown">
                    <div class="mb-3 justify-content-end d-flex">
                        <button class="btn btn-primary" (click)="openAnnouncementModal(createAnnouncementModal)">
                            <i class="bi bi-plus"></i> Tạo thông báo mới
                        </button>
                    </div>

                    <div *ngIf="announcements.length === 0" class="text-muted">Chưa có thông báo nào</div>

                    <div *ngFor="let announcement of announcements" class="card mb-4" style="cursor: pointer">
                        <div class="card-body">
                            <h6 class="card-title">{{ announcement.title }}</h6>
                            <div class="card-text">
                                <div
                                    class="text-decoration-none"
                                    (click)="viewAnnouncementDetail(announcement, announcementDetailModal)"
                                >
                                    {{
                                        announcement.content.length > 100
                                            ? (announcement.content | slice: 0 : 100) + '...'
                                            : announcement.content
                                    }}
                                </div>
                            </div>
                            <small class="text-muted">
                                <i class="bi bi-calendar me-1"></i>
                                {{ announcement.createdAt | date: 'dd/MM/yyyy HH:mm' }}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal tạo thông báo - Improved -->
<ng-template #createAnnouncementModal let-modal>
    <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-primary px-4">
            <h5 class="modal-title fw-semibold text-white"><i class="bi bi-megaphone me-2"></i>Tạo thông báo mới</h5>
            <button type="button" class="btn-close btn-close-white" (click)="modal.dismiss('cancel')"></button>
        </div>
        <div class="modal-body p-4">
            <form (ngSubmit)="createAnnouncement()">
                <div class="mb-4">
                    <label for="announcementTitle" class="form-label fw-medium">
                        <i class="bi bi-card-heading me-1 text-primary"></i>Tiêu đề
                    </label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-primary">
                            <i class="bi bi-pencil text-primary"></i>
                        </span>
                        <input
                            type="text"
                            class="form-control form-control-lg border-primary border-end-1"
                            id="announcementTitle"
                            [(ngModel)]="newAnnouncement.title"
                            name="title"
                            required
                            placeholder="Nhập tiêu đề thông báo"
                        />
                    </div>
                </div>
                <div class="mb-4">
                    <label for="announcementContent" class="form-label fw-medium">
                        <i class="bi bi-text-paragraph me-1 text-primary"></i>Nội dung
                    </label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-primary align-items-start">
                            <i class="bi bi-chat-left-text text-primary mt-1"></i>
                        </span>
                        <textarea
                            class="form-control form-control-lg border-primary border-end-1"
                            id="announcementContent"
                            rows="6"
                            [(ngModel)]="newAnnouncement.content"
                            name="content"
                            required
                            placeholder="Nhập nội dung thông báo"
                        ></textarea>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button
                        type="button"
                        class="btn btn-outline-secondary rounded-2 px-4"
                        (click)="modal.dismiss('cancel')"
                    >
                        Hủy
                    </button>
                    <button
                        type="submit"
                        class="btn btn-primary rounded-2 px-4"
                        [disabled]="disableCreateAnnouncementButton()"
                    >
                        <i class="bi bi-send-check me-2"></i>Tạo thông báo
                    </button>
                </div>
            </form>
        </div>
    </div>
</ng-template>

<!-- Modal chi tiết thông báo - Improved -->
<ng-template #announcementDetailModal let-modal>
    <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-info px-4">
            <h5 class="modal-title fw-semibold text-white">
                <i class="bi bi-file-earmark-text me-2"></i>{{ selectedAnnouncement?.title }}
            </h5>
            <button type="button" class="btn-close btn-close-white" (click)="modal.dismiss('cancel')"></button>
        </div>
        <div class="modal-body p-4">
            <div class="mb-4">
                <div class="border p-3 bg-light rounded">
                    <div class="preformatted-text" [innerHTML]="selectedAnnouncement?.content"></div>
                </div>
            </div>
            <div class="text-muted small">
                <i class="bi bi-calendar me-1"></i>
                Ngày tạo: {{ selectedAnnouncement?.createdAt | date: 'dd/MM/yyyy HH:mm' }}
            </div>
        </div>
        <div class="modal-footer bg-light">
            <button type="button" class="btn btn-outline-secondary rounded-2 px-4" (click)="modal.dismiss('cancel')">
                Đóng
            </button>
        </div>
    </div>
</ng-template>

<!-- Modal tạo tài liệu - Improved -->
<ng-template #createDocumentModal let-modal>
    <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-primary px-4">
            <h5 class="modal-title fw-semibold text-white">
                <i class="bi bi-file-earmark-plus me-2"></i>Thêm tài liệu
            </h5>
            <button type="button" class="btn-close btn-close-white" (click)="modal.dismiss('cancel')"></button>
        </div>
        <div class="modal-body p-4">
            <form (ngSubmit)="createDocument()">
                <div class="mb-4">
                    <label for="documentTitle" class="form-label fw-medium">
                        <i class="bi bi-card-heading me-1 text-primary"></i>Tiêu đề
                    </label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-primary">
                            <i class="bi bi-pencil text-primary"></i>
                        </span>
                        <input
                            type="text"
                            class="form-control form-control-lg border-primary border-end-1"
                            id="documentTitle"
                            [(ngModel)]="newDocument.title"
                            name="title"
                            required
                            placeholder="Nhập tiêu đề tài liệu"
                        />
                    </div>
                </div>
                <div class="mb-4">
                    <label for="documentContent" class="form-label fw-medium">
                        <i class="bi bi-text-paragraph me-1 text-primary"></i>Mô tả
                    </label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-primary align-items-start">
                            <i class="bi bi-chat-left-text text-primary mt-1"></i>
                        </span>
                        <textarea
                            class="form-control form-control-lg border-primary border-end-1 rounded-end-2"
                            id="documentContent"
                            rows="4"
                            [(ngModel)]="newDocument.content"
                            name="content"
                            required
                            placeholder="Nhập mô tả tài liệu"
                        ></textarea>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="documentFile" class="form-label fw-medium d-flex align-items-center cursor-pointer">
                        <i class="bi bi-paperclip me-1 text-primary"></i> File đính kèm
                    </label>
                    <div class="input-group">
                        <button type="button" class="btn btn-outline-primary" (click)="fileInput.click()">
                            <i class="bi bi-file-earmark-arrow-up me-1"></i> Chọn file
                        </button>
                        <input
                            type="file"
                            class="d-none"
                            id="documentFile"
                            #fileInput
                            (change)="onFileSelect($event)"
                            required
                        />
                        <input
                            type="text"
                            class="form-control form-control-lg border-primary"
                            [value]="selectedFile?.name || 'Chưa chọn file'"
                            readonly
                        />
                    </div>
                </div>

                <div class="modal-footer bg-light">
                    <button
                        type="button"
                        class="btn btn-outline-secondary rounded-2 px-4"
                        (click)="modal.dismiss('cancel')"
                    >
                        Hủy
                    </button>
                    <button
                        type="submit"
                        class="btn btn-primary rounded-2 px-4"
                        [disabled]="disableCreateDocumentButton()"
                    >
                        <i class="bi bi-save me-2"></i>Thêm tài liệu
                    </button>
                </div>
            </form>
        </div>
    </div>
</ng-template>

<!-- Modal tạo bài tập - Improved -->
<ng-template #createAssignmentModal let-modal>
    <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-primary px-4">
            <h5 class="modal-title fw-semibold text-white"><i class="bi bi-journal-plus me-2"></i>Thêm bài tập</h5>
            <button type="button" class="btn-close btn-close-white" (click)="modal.dismiss('cancel')"></button>
        </div>
        <div class="modal-body p-4">
            <form (ngSubmit)="createAssignment()">
                <div class="mb-4">
                    <label for="assignmentTitle" class="form-label fw-medium">
                        <i class="bi bi-card-heading me-1 text-primary"></i>Tiêu đề
                    </label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-primary">
                            <i class="bi bi-pencil text-primary"></i>
                        </span>
                        <input
                            type="text"
                            class="form-control form-control-lg border-primary border-end-1"
                            id="assignmentTitle"
                            [(ngModel)]="newAssignment.title"
                            name="title"
                            required
                            placeholder="Nhập tiêu đề bài tập"
                        />
                    </div>
                </div>
                <div class="mb-4">
                    <label for="assignmentContent" class="form-label fw-medium">
                        <i class="bi bi-text-paragraph me-1 text-primary"></i>Nội dung
                    </label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-primary align-items-start">
                            <i class="bi bi-chat-left-text text-primary mt-1"></i>
                        </span>
                        <textarea
                            class="form-control form-control-lg border-primary border-end-1"
                            id="assignmentContent"
                            rows="4"
                            [(ngModel)]="newAssignment.content"
                            name="content"
                            required
                            placeholder="Nhập nội dung bài tập"
                        ></textarea>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="assignmentDeadline" class="form-label fw-medium">
                        <i class="bi bi-calendar-date me-1 text-primary"></i>Hạn nộp
                    </label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-primary">
                            <i class="bi bi-clock text-primary"></i>
                        </span>
                        <input
                            type="date"
                            class="form-control form-control-lg border-primary border-end-1"
                            id="assignmentDeadline"
                            [(ngModel)]="newAssignment.deadline"
                            name="deadline"
                            required
                        />
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button
                        type="button"
                        class="btn btn-outline-secondary rounded-2 px-4"
                        (click)="modal.dismiss('cancel')"
                    >
                        Hủy
                    </button>
                    <button
                        type="submit"
                        class="btn btn-success rounded-2 px-4"
                        [disabled]="disableCreateAssignmentButton()"
                    >
                        <i class="bi bi-check-circle me-2"></i>Thêm bài tập
                    </button>
                </div>
            </form>
        </div>
    </div>
</ng-template>

<!-- Delete Confirmation Modal - Improved -->
<ng-template #deleteAssignmentModal let-modal>
    <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-danger px-4">
            <h5 class="modal-title fw-semibold text-white">
                <i class="bi bi-exclamation-triangle me-2"></i>Xác nhận xóa
            </h5>
            <button
                type="button"
                class="btn-close btn-close-white"
                (click)="modal.dismiss('cancel')"
                aria-label="Close"
            ></button>
        </div>
        <div class="modal-body p-4 text-center">
            <i class="bi bi-exclamation-octagon text-danger display-4 mb-3"></i>
            <h5 class="fw-bold mb-3">Bạn có chắc chắn muốn xóa bài tập này?</h5>
            <p class="fs-5 text-danger fw-medium mb-4">{{ assignmentToDelete?.title }}</p>
            <p class="text-muted small"><i class="bi bi-info-circle me-1"></i>Hành động này không thể hoàn tác.</p>
        </div>
        <div class="modal-footer bg-light">
            <button type="button" class="btn btn-outline-secondary rounded-2 px-4" (click)="modal.dismiss('cancel')">
                Hủy
            </button>
            <button type="button" class="btn btn-danger rounded-2 px-4" (click)="deleteAssignment()">
                <i class="bi bi-trash me-2"></i>Xóa
            </button>
        </div>
    </div>
</ng-template>

<!-- Delete Document Modal - Improved -->
<ng-template #deleteDocumentModal let-modal>
    <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-danger px-4">
            <h5 class="modal-title fw-semibold text-white">
                <i class="bi bi-exclamation-triangle me-2"></i>Xác nhận xóa
            </h5>
            <button
                type="button"
                class="btn-close btn-close-white"
                (click)="modal.dismiss('cancel')"
                aria-label="Close"
            ></button>
        </div>
        <div class="modal-body p-4 text-center">
            <i class="bi bi-exclamation-octagon text-danger display-4 mb-3"></i>
            <h5 class="fw-bold mb-3">Bạn có chắc chắn muốn xóa tài liệu này?</h5>
            <p class="fs-5 text-danger fw-medium mb-4">{{ documentToDelete?.title }}</p>
            <p class="text-muted small"><i class="bi bi-info-circle me-1"></i>Hành động này không thể hoàn tác.</p>
        </div>
        <div class="modal-footer bg-light">
            <button type="button" class="btn btn-outline-secondary rounded-2 px-4" (click)="modal.dismiss('cancel')">
                Hủy
            </button>
            <button type="button" class="btn btn-danger rounded-2 px-4" (click)="deleteDocument()">
                <i class="bi bi-trash me-2"></i>Xóa
            </button>
        </div>
    </div>
</ng-template>
