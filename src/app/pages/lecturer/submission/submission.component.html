<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <!-- <h2 class="page-title">Bài nộp của sinh viên cho {{ assignment.title ||  }}</h2> -->
        </div>
    </div>

    <!-- Download All Button -->
    <div class="row mb-3">
        <div class="col-12 justify-content-end d-flex">
            <button type="button" class="btn btn-primary btn-download-all" (click)="downloadAllSubmissions()">
                <i class="bi bi-download me-2"></i>
                Tải xuống tất cả bài nộp
            </button>
        </div>
    </div>

    <!-- Submissions Table -->
    <div class="row">
        <div class="col-12">
            <div class="table-container">
                <table class="table table-hover table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col" class="text-center">Mã sinh viên</th>
                            <th scope="col" class="text-center">Tình trạng nộp bài</th>
                            <th scope="col" class="text-center">Tên file</th>
                            <th scope="col" class="text-center">Thời gian nộp</th>
                            <th scope="col" class="text-center">Hành động</th>
                        </tr>
                    </thead>

                    <tbody *ngIf="isLoadingSubmissions" class="text-center">
                        <tr>
                            <td colspan="5" class="text-center overflow-hidden">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Đang tải...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>

                    <tbody *ngIf="!isLoadingSubmissions">
                        <tr *ngFor="let submission of studentSubmissions.contents">
                            <td class="text-center fw-bold">{{ submission.studentCode }}</td>
                            <td class="text-center">
                                <span class="badge" [ngClass]="getStatusBadgeClass(submission.isSubmitted)">
                                    {{ getStatusText(submission.isSubmitted) }}
                                </span>
                            </td>
                            <td class="text-center">
                                <span *ngIf="submission.fileName; else noFile" class="file-name">
                                    {{ submission.fileName }}
                                </span>
                                <ng-template #noFile>
                                    <span class="text-muted">---</span>
                                </ng-template>
                            </td>
                            <td class="text-center">
                                <span *ngIf="submission.uploadAt; else noTime">
                                    {{ submission.uploadAt | date: 'dd/MM/yyyy HH:mm:ss' }}
                                </span>
                                <ng-template #noTime>
                                    <span class="text-muted">---</span>
                                </ng-template>
                            </td>
                            <td class="text-center">
                                <div class="action-buttons">
                                    <button
                                        type="button"
                                        class="btn btn-sm btn-outline-info me-2"
                                        (click)="viewSubmissionHistory(submission)"
                                    >
                                        <i class="bi bi-arrow-counterclockwise me-1"></i>
                                        Lịch sử
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-sm btn-outline-success"
                                        [disabled]="!submission.fileId"
                                        (click)="downloadFile(submission)"
                                    >
                                        <i class="bi bi-download me-1"></i>
                                        Tải file
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- History Modal -->
<div
    class="modal fade show"
    [style.display]="showHistoryModal ? 'block' : 'none'"
    [class.show]="showHistoryModal"
    tabindex="-1"
    role="dialog"
>
    <div class="modal-backdrop fade show" *ngIf="showHistoryModal"></div>
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-arrow-counterclockwise me-2"></i>
                    Lịch sử nộp bài - {{ selectedStudent?.studentCode }}
                </h5>
                <button type="button" class="btn-close" (click)="closeModal()" aria-label="Close"></button>
            </div>

            <div class="modal-body" *ngIf="selectedStudent">
                <div *ngIf="isLoadingHistory" class="text-center text-muted py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <div
                    *ngIf="getSubmissionHistories(selectedStudent.studentCode) && !isLoadingHistory"
                    class="text-center text-muted py-4"
                >
                    <i class="bi bi-inbox fa-3x mb-3"></i>
                    <p>Sinh viên này chưa có lịch sử nộp bài</p>
                </div>
                <div *ngIf="getSubmissionHistories(selectedStudent.studentCode).length > 0" class="history-container">
                    <table class="table table-striped">
                        <thead class="table-light">
                            <tr>
                                <th scope="col" class="text-center">Hành động</th>
                                <th scope="col" class="text-center">Tên file</th>
                                <th scope="col" class="text-center">Thời gian</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let history of getSubmissionHistories(selectedStudent.studentCode)">
                                <td class="text-center">
                                    <span class="badge" [ngClass]="getActionBadgeClass(history.action)">
                                        {{ getActionText(history.action) }}
                                    </span>
                                </td>
                                <td class="text-center">{{ history.fileName }}</td>
                                <td class="text-center">{{ history.performAt | date: 'dd/MM/yyyy HH:mm:ss' }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeModal()">Đóng</button>
            </div>
        </div>
    </div>
</div>
